---
- name: Disable IPv6 with sysctl
  sysctl: name={{ item }} value=1 state=present reload=yes
  with_items:
    - net.ipv6.conf.all.disable_ipv6
    - net.ipv6.conf.default.disable_ipv6
    - net.ipv6.conf.lo.disable_ipv6

- name: Debian | blacklist ipv6 in modprobe
  ansible.builtin.lineinfile:
    dest: /etc/modprobe.d/blacklist.conf
    line: 'blacklist ipv6'
    mode: '0644'
    create: yes

- name: Make sure we've got nfs-common
  ansible.builtin.apt:
    pkg:
      - nfs-common
    update_cache: yes
    cache_valid_time: 3600

- name: Mount the big jawn
  ansible.posix.mount:
    path: /mnt/
    # was autodiscovered - do i have to persist this somehow
    src: /dev/md127
    fstype: ext4
    state: present

- name: Create manifests dir
  ansible.builtin.file:
    path: /opt/manifests
    state: directory
    mode: '0755'

- name: Template over jellyfin kube yaml
  ansible.builtin.template:
    src: "{{ item }}"
    dest: "/opt/manifests/{{ item }}"
    backup: yes
  loop:
    - jellyfin.yaml
    - transmission.yaml
    - sonarr.yaml
    - jackett.yaml
    - trustmission.yaml

- name: Apply in kube yaml
  ansible.builtin.command: microk8s kubectl apply -f /opt/manifests
